---
title: Production Run Control Script
subtitle: | 
          | CSTAT Case: C1788
          | Clients: Campbell, Rebecca; Ashley, Autumn; Dontje, Katherine
author: 
  - name: Steven J. Pierce
    orcid: 0000-0002-0679-3019
    email: pierces1@msu.edu
    affiliations: 
      - name: Michigan State University, Center for Statistical Training and Consulting  ([https://cstat.msu.edu](https://cstat.msu.edu))
bibliography: references.bib          # File holds BibTeX data for references
csl: apa.csl                          # File controls citation & reference list format
params:                               # Default values for parameters
  SourceDir: "scripts/"               # Relative path to folder holding this file
  SourceFile: "Production_Run.qmd"    # Name of this script file
  LogFile: "Production_Run.html"      # Default name of rendered output file
date: now                             # Sets Date Published = when script is rendered
date-modified: last-modified          # Sets Date Modified = when code was last saved
date-format: YYYY-MM-DD HH:mm:ss z    # Show date, time, & timezone
css: CSTAT_style.css                  # File formats title banner block w/ logo.
title-block-banner: true              # Enable the banner, per CSTAT_style.css 
title-block-banner-color: "#18453B"   # Spartan Green color for title text. 
format: 
  html:                               # Settings for HTML output
    output-file: "Production_Run.html"         # Default output file name
    theme: [default, brand, CSTAT_theme.scss]  # Theme controls output formatting
    toc: true                         # Include table of contents (TOC)
    toc-depth: 3                      # Number of layers in TOC
    toc-location: left                # Where to display the TOC
    number-sections: true             # Auto-number each section
    number-depth: 3                   # Number of layers for section numbering
    code-fold: true                   # Default to collapsing code chunks
    code-tools: true                  # Adds control for show/hide all code
    code-line-numbers: false          # Skip numbering lines in code chunks
    embed-resources: true             # Makes HTML output file self-contained
    anchor-sections: true             # Allow linking to section headings
execute:                              # Default Quarto chunk execution options
  eval: true
  echo: fenced                        # Show the code in the output file
  output: true
  warning: true
  error: true
  include: true
knitr:                                # Default R knitr package chunk options
  opts_chunk: 
    message: true
---

\FloatBarrier

# Purpose
This file is part of a research compendium [@Pierce-RN8756] associated with a 
study about a sexual assault nurse examiner training program [@Dontje-RN8757]. 
This script automates rendering other scripts in the compendium in the correct 
order. It also overrides the default draft output file names with date-stamped, 
production output file names. You can read my 
[blog post](https://sjpierce.github.io/posts/output/draft_vs_production.html) 
about why I separate draft from production output this way. 

One can use this script interactively to render one or more of the other scripts 
but its primary usage will be to run the entire set sequentially in a batch 
process. 

# Setup
This section contains chunks that you must run before trying to use the code 
chunks in other sections below it to interactively render a specific script. 

Global R chunk options are defined in the YAML header but local chunk options
will over-ride global options. We can temporarily disable an individual chunk by
inserting `#| eval: false` on a line at the top of the chunk.

## Load Packages
R packages usually add new functions to the base R software, allowing you to do 
more things. Here, we load the specific R packages required for this script to 
work.

```{r}
#| label: load-packages

library(devtools)       # for session_info()
library(here)           # for here(), i_am(), makes code more portable.
library(rmarkdown)      # for pandoc_version()
library(piercer)        # for git_report()
library(quarto)         # for quarto_version()
library(SANETPA)        # for version info 
```

## Declare Path
This next chunk declares the path to this script relative to the project-level 
root directory. If the file is not in the right location under the project root
you'll get a warning message. This helps ensure relative paths are all working 
as expected. The chunk below uses the `SourceDir` and `SourceFile` parameters 
set in the YAML header. 

``` {r}
#| label: declare-path

# Declare path to this script relative to the project root directory.
here::i_am(path = paste0(params$SourceDir, params$SourceFile))
```

# Workflow
Scripts in the SANETPA package can generate either draft or production output.
I wrote a 
[blog post](https://sjpierce.github.io/posts/output/draft_vs_production.html) 
describing my general rationale and approach for doing that. I implemented that 
strategy in this compendium. @fig-production shows the production workflow 
implemented by this script. 
 
```{dot}
//| label: fig-production
//| fig-cap: "Data Flow Diagram"
//| fig-width: 7
//| fig-height: 3.5

digraph Production {
rankdir="LR";

node [shape = "box", style= "filled", fontname = "Arial", fontsize = 9, fillcolor = "#C3FFEC"]
Script2 [label = "CR_Model.qmd\n(Quarto Script)"]
HTML2 [label = "CR_Model_YYYY-MM-DD.pdf\n(PDF Output)"]
Script1 [label = "Import_Data.qmd\n(Quarto Script)"]
RawData [label = "Raw_Data.sav\n(SPSS Data File)"]
FinalData [label = "Final_Data.RData\n(R Data File)"]
HTML1 [label = "Import_Data_YYYY-MM-DD.pdf\n(PDF Output)"]
HTML0 [label = "Production_Run.html\n(HTML Output)"]
Script0 [label = "Production_Run.qmd\n(Quarto Script)"]

edge [fontname = "Arial", fontsize = 9]
Script0 -> Script1 [label = "Render with\ncustom parameters"]
Script0 -> Script2 [label = "Render with\ncustom parameters"]
RawData -> Script1 [label = "Read"]
Script0 -> HTML0 [label = "Renders"]
Script1 -> HTML1 [label = "Renders"]
Script1 -> FinalData [label = "Write"]
FinalData -> Script2 [label = "Read"]
Script2 -> HTML2 [label = "Renders"]

{ rank=same; RawData; Script2; Script1; FinalData}
{ rank=same; Script0; HTML0}
}
```

# Render Other Scripts
Each subsection below contains code that will render another Quarto script. By 
default I am storing the Quarto scripts to be rendered in the `scripts/` folder 
which is a Quarto project) and their output will be stored in the 
`scripts/output/` because of the `output-dir: "output"` setting in the 
`scripts/_quarto.yml` file. 

If enough scripts accumulate that I need to organize them into one or more 
subfolders under `scripts/`, the outputs should automatically get stored in a 
corresponding set of subfolders under `scripts/output/`. For example, a script 
stored in `scripts/example/` will end up putting output in a subfolder 
called `scripts/output/example/`). 

## Import Data
Work on this script has begun but we don't yet have the required data file. The 
chunk is disabled for now. 

``` {r}
#| label: Import-Data
#| eval: false

# Memory garbage collection (for more consistent chunk timing).
gc()

# Start chunk timer.
chunk.start <- proc.time()

OutFile <- paste0("Import_Data_", Sys.Date(), ".html")

# Render the script in a fresh R session.
quarto_render(input = here::here("scripts/Import_Data.qmd"), 
              output_format = "html",
              output_file = OutFile, 
              execute_params = list(SourceDir = params$SourceDir, 
                                    SourceFile = "Import_Data.qmd", 
                                    LogFile = OutFile),
              execute_dir = here::here("scripts"),
              as_job = "auto")

# End chunk timer
chunk.end <- proc.time()
chunk.end - chunk.start
```

## Continuation-Ratio Model
Work on this script has not really started yet. It is just a skeleton for future 
use, so the chunk below is currently disabled. 

``` {r}
#| label: CR-Model
#| eval: false

# Memory garbage collection (for more consistent chunk timing).
gc()

# Start chunk timer.
chunk.start <- proc.time()

OutFile <- paste0("CR_Model_", Sys.Date(), ".html")

# Render the script in a fresh R session.
quarto_render(input = here::here("scripts/CR_Model.qmd"), 
              output_format = "html",
              output_file = OutFile, 
              execute_params = list(SourceDir = params$SourceDir, 
                                    SourceFile = "CR_Model.qmd", 
                                    LogFile = OutFile),
              execute_dir = here::here("scripts"),
              as_job = "auto")

# End chunk timer
chunk.end <- proc.time()
chunk.end - chunk.start
```

# References
::: {#refs}
:::

# Software Information
This section documents information that is important for reproducibility. Most
users will not need to read it. It is primarily here for use by the statistician 
on the team if we need to troubleshoot reproducibility issues because someone 
else is unable to get the same results from the same code. Start by checking for 
differences in package versions. 

We used [R](https://www.r-project.org/) as our main computing environment and
[Quarto](https://quarto.org/) scripts to enhance reproducibility. We used
[RStudio](www.rstudio.org) as the editor to interface with R and Quarto.

- Software chain:
  **qmd file > RStudio > Quarto > R > knitr > md file > Pandoc > HTML file**.
- Source file: **`{r} paste0(params$SourceDir, params$SourceFile)`**
- Output file: **`{r} paste0(params$SourceDir, "output/", params$LogFile)`**
- [Quarto `{r} quarto_version()`](https://quarto.org/) runs `*.qmd` files through 
  [R](https://www.r-project.org/) and [knitr](https://yihui.org/knitr/) to 
  produce `*.md` markdown files.
- [Pandoc `{r} rmarkdown::pandoc_version()`](https://pandoc.org) converts 
  markdown files (`*.md`) to other formats, including LaTeX (`*.tex`) and HTML 
  (`*.html`) among others.

## Versions
This document was generated using the following computational environment and 
dependencies:

```{r}
#| label: show-version
#| echo: true

# Get R and R package version numbers in use.
devtools::session_info()
```

## Git Details
The current Git commit details and status are:

``` {r}
#| label: git-details
#| echo: true

git_report()
```

This is useful because it tells us exactly which commit in the Git history 
we would need to be using to make sure we are running the exact same code. 
Sometimes another person is not using the most current code, or has changed the 
code in some way since it was last committed.  

::: {.callout-tip}
Untracked files are files located in the repository that Git has not been told 
to entirely ignore, but have also not been committed into the version history. 

Unstaged changes to files indicate that some of the contents have been modified 
since the last time the file was committed to Git. In production runs, we want 
the Git output to not show any unstaged changes to key files!
::: 
